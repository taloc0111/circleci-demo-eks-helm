# This code is licensed from CircleCI to the user under the MIT license. See
# https://circleci.com/orbs/registry/licensing for details.
# https://circleci.com/orbs/registry/licensing for details.
version: 2.1
orbs:
  aws-cli: circleci/aws-cli@0.1.14

description: |
  Deploy a helm chart on AWS EKS
commands:
  setup-kube:
    parameters:
      cluster:
        type: string
      namespace:
        default: default
        type: string
    steps:
      - aws-cli/configure
      - run:
          name: Configure Kubernetes Client
          command: |
            aws eks update-kubeconfig --name  << parameters.cluster >>
            kubectl config set-context $(kubectl config current-context) --namespace << parameters.namespace >>
            # sanity check
            kubectl get services

  init-helm:
    parameters:
      chart:
        type: string
    steps:
      - aws-cli/configure
      - run:
          name: Initialise Helm
          command: |
            helm init --client-only
            helm list | grep << parameters.chart >>
  init-helmv3:
    parameters:
      chart:
        type: string
    steps:
      - aws-cli/configure
      - run:
          name: Initialise Helm
          command: |
            helm list | grep << parameters.chart >>
  upgrade:
    parameters:
      helmparams:
        default:
        type: string
      chart:
        type: string
      language:
        default: 'js'
        description: Chart type for helm - defaults to "js"
        type: enum
        enum: ['js', 'go']
    steps:
      - aws-cli/configure
      - run:
          name: Update Cluster
          command: |
            pwd
            ls -lah 
            helm upgrade << parameters.chart >> << parameters.helmparams >> ./charts/sibi<< parameters.language >>/
  upgrade-or-install:
    parameters:
      helmparams:
        default:
        type: string
      chart:
        type: string
      language:
        default: 'js'
        description: Chart type for helm - defaults to "js"
        type: enum
        enum: ['js', 'go']
    steps:
      - aws-cli/configure
      - run:
          name: Update Cluster
          command: |
            pwd
            ls -lah 
            helm upgrade --install << parameters.chart >> << parameters.helmparams>> ./charts/sibi<< parameters.language >>/
  roll-back:
    parameters:
      helmparams:
        default:
        type: string
      chart:
        type: string
    steps:
      - aws-cli/configure
      - run:
          name: Rollback Deployment
          command: |
            helm rollback << parameters.chart >> $(helm history << parameters.chart >> | grep DEPLOYED | awk '{print $1}') || export STATUS=$?
            exit ${STATUS}
executors:
  default:
    docker:
      - image: sibipro/sibi-helm:549a925e46f5
  helmv3:
    docker:
      - image: sibipro/sibi-helm:0.2